<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海龟汤在线小屋</title>
    <style>
        :root { --color-bg: #f4f3f1; --color-primary: #a7b2c3; --color-secondary: #d3c4be; --color-text: #5a5a5a; --color-text-light: #888; --color-border: #e0e0e0; --color-highlight: #f5e6d3; --color-success: #8dbba2; --color-fail: #e09a9a; --color-reset: #a7b2c3; --font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; --border-radius: 12px; --transition-speed: 0.3s; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-family); background-color: var(--color-bg); color: var(--color-text); overflow: hidden; }
        .centered-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--color-secondary), var(--color-primary)); transition: opacity 0.5s ease-out; }
        .centered-container h1 { color: white; font-size: 2.8em; font-weight: 300; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); text-align: center; padding: 0 20px;}
        .input-group { margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .room-input { padding: 15px 25px; font-size: 1.2em; border-radius: 50px; border: 2px solid white; background-color: rgba(255, 255, 255, 0.2); color: white; text-align: center; outline: none; transition: all var(--transition-speed) ease; }
        .room-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .room-input:focus { background-color: rgba(255, 255, 255, 0.4); border-color: white; }
        .join-btn { padding: 15px 35px; font-size: 1.2em; border-radius: 50px; border: none; cursor: pointer; background-color: white; color: var(--color-primary); font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all var(--transition-speed) ease; }
        .join-btn:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .game-container { display: none; grid-template-columns: 3fr 5fr 3fr; height: 100vh; gap: 15px; padding: 15px; box-sizing: border-box; }
        .panel { background-color: white; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px 25px; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { margin-top: 0; margin-bottom: 15px; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 10px; font-weight: 500; }
        .tab-nav { display: flex; }
        .tab-btn { flex: 1; padding: 12px; border: 1px solid var(--color-border); background-color: var(--color-bg); cursor: pointer; transition: all var(--transition-speed); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px; font-size: 0.95em; }
        #question-input { font-size: 0.95em; }
        .message-area { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 12px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .message.player-msg { background-color: #eef1f5; align-self: flex-start; cursor: pointer; transition: background-color var(--transition-speed); }
        .message.host-msg { background-color: var(--color-secondary); color: white; align-self: flex-end; }
        .message-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 4px; color: var(--color-primary); }
        .panel-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--color-border); }
        .input-area { display: flex; gap: 10px; }
        .message-input { flex-grow: 1; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1em; font-family: var(--font-family); background-color: var(--color-bg); transition: all var(--transition-speed) ease; }
        .clue-list { flex-grow:1; overflow-y: auto; list-style-type: none; padding: 0; margin: 0; }
        .clue-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--color-border); transition: background-color var(--transition-speed); }
        .clue-item.highlighted { background-color: var(--color-highlight); font-weight: bold; }
        .clue-text { flex-grow: 1; line-height: 1.5; }
        .clue-actions button { background: none; border: none; cursor: pointer; margin-left: 8px; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 50%;}
        .clue-icon { width: 18px; height: 18px; fill: var(--color-text-light); transition: all var(--transition-speed); }
        .download-btn { width: 100%; padding: 12px; margin-top: 15px; border: 1px solid var(--color-primary); background-color: transparent; color: var(--color-primary); border-radius: 8px; cursor: pointer; transition: all var(--transition-speed); }
        .download-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .hidden { display: none !important; } .fade-out { opacity: 0; pointer-events: none; }
        
        /* 新增：移动端导航栏样式 */
        #mobile-nav { display: none; /* 默认在桌面端隐藏 */ }

        /* 核心修改：响应式设计 */
        @media (max-width: 768px) {
            body { overflow: auto; }
            .game-container {
                display: block; /* 破坏网格布局 */
                height: 100%;
                padding: 10px 10px 70px 10px; /* 底部留出导航栏空间 */
            }
            .panel {
                display: none; /* 所有面板默认隐藏 */
                height: 100%;
                width: 100%;
                padding: 15px;
                box-sizing: border-box;
            }
            .panel.mobile-visible {
                display: flex; /* 只显示被选中的面板 */
            }
            #mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px;
                background-color: white;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
            }
            .mobile-nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: none;
                border: none;
                font-size: 12px;
                color: var(--color-text-light);
                padding: 8px 0;
                cursor: pointer;
                transition: color var(--transition-speed);
            }
            .mobile-nav-btn .nav-icon {
                width: 24px;
                height: 24px;
                fill: var(--color-text-light);
                margin-bottom: 2px;
                transition: fill var(--transition-speed);
            }
            .mobile-nav-btn.active, .mobile-nav-btn:hover {
                color: var(--color-primary);
            }
            .mobile-nav-btn.active .nav-icon, .mobile-nav-btn:hover .nav-icon {
                fill: var(--color-primary);
            }
        }
    </style>
</head>
<body>
    <div id="room-selection" class="centered-container"><h1>海龟汤在线小屋</h1><div class="input-group"><input type="text" id="room-input" class="room-input" placeholder="请输入房间号"><button id="join-room-btn" class="join-btn">加入/创建房间</button></div></div>
    <div id="host-prompt" class="centered-container hidden"><h1>房间为空</h1><div class="input-group"><button id="become-host-btn" class="join-btn">成为本局主持人</button></div></div>

    <div id="host-view" class="game-container">
        <div id="host-left-panel" class="panel"><div class="tab-nav"><button class="tab-btn active" onclick="switchTab('host', 'question')">海龟汤题目</button><button class="tab-btn" onclick="switchTab('host', 'manual')">主持人手册</button></div><div class="tab-content-container"><div id="host-question-content" class="tab-content active"><textarea id="question-input" class="editable-content" placeholder="在此输入“汤面”..."></textarea></div><div id="host-manual-content" class="tab-content"><textarea id="manual-input" class="editable-content" placeholder="在此输入“汤底”..."></textarea></div></div><div class="game-result-buttons"><button id="btn-success" class="result-btn">喝汤成功</button><button id="btn-fail" class="result-btn">喝汤失败</button><button id="btn-reset" class="result-btn hidden">重置游戏</button></div></div>
        <div id="host-middle-panel" class="panel"><h3 class="panel-title">信息互动区</h3><div id="host-message-area" class="message-area"></div><div class="panel-footer"><div class="quick-reply-buttons"><button class="quick-reply-btn" onclick="quickReply('是')">是</button><button class="quick-reply-btn" onclick="quickReply('不是')">不是</button><button class="quick-reply-btn" onclick="quickReply('是也不是')">是也不是</button></div><div class="input-area"><input type="text" id="host-message-input" class="message-input" placeholder="输入自定义回复..."><button id="host-send-btn" class="send-btn">发送</button></div></div></div>
        <div id="host-right-panel" class="panel"><h3 class="panel-title">线索列表</h3><ul id="host-clue-list" class="clue-list"></ul><button id="host-download-btn" class="download-btn" disabled>下载本局复盘</button></div>
    </div>

    <div id="player-view" class="game-container">
        <div id="player-left-panel" class="panel"><h3 class="panel-title">海龟汤题目</h3><div id="player-question-display" style="font-size: 1.1em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; flex-grow: 1;">主持人尚未出题...</div></div>
        <div id="player-middle-panel" class="panel"><h3 class="panel-title">提问区</h3><div id="player-message-area" class="message-area"></div><div class="panel-footer"><div class="input-area"><input type="text" id="player-message-input" class="message-input" placeholder="向主持人提问..."><button id="player-send-btn" class="send-btn">发送</button></div></div></div>
        <div id="player-right-panel" class="panel"><h3 class="panel-title">线索列表</h3><ul id="player-clue-list" class="clue-list"></ul><button id="player-download-btn" class="download-btn" disabled>下载本局复盘</button></div>
    </div>
    
    <!-- 新增：移动端导航栏 -->
    <div id="mobile-nav">
        <button id="mobile-nav-topic" class="mobile-nav-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg><span>汤面</span></button>
        <button id="mobile-nav-chat" class="mobile-nav-btn active"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg><span>聊天</span></button>
        <button id="mobile-nav-clues" class="mobile-nav-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zm0-5h18v-2H3v2zm0-5h18V6H3v2zm15 10l-4-4 4-4v8z"/></svg><span>线索</span></button>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io("https://hgtang.onrender.com", { transports: ["websocket"] });
        let myRole = null;
        let currentRoomID = null;

        // ... (获取所有旧的DOM元素)
        const roomSelectionView = document.getElementById('room-selection'); const hostPromptView = document.getElementById('host-prompt'); const roomInput = document.getElementById('room-input'); const joinRoomBtn = document.getElementById('join-room-btn'); const becomeHostBtn = document.getElementById('become-host-btn');
        const hostView = document.getElementById('host-view'); const playerView = document.getElementById('player-view'); const questionInput = document.getElementById('question-input'); const manualInput = document.getElementById('manual-input'); const hostMessageArea = document.getElementById('host-message-area'); const hostMessageInput = document.getElementById('host-message-input'); const hostClueList = document.getElementById('host-clue-list'); const btnSuccess = document.getElementById('btn-success'); const btnFail = document.getElementById('btn-fail'); const btnReset = document.getElementById('btn-reset'); const playerQuestionDisplay = document.getElementById('player-question-display'); const playerMessageArea = document.getElementById('player-message-area'); const playerMessageInput = document.getElementById('player-message-input'); const playerClueList = document.getElementById('player-clue-list');
        const hostDownloadBtn = document.getElementById('host-download-btn'); const playerDownloadBtn = document.getElementById('player-download-btn');
        
        // 新增：获取移动端导航和面板元素
        const mobileNav = document.getElementById('mobile-nav');
        const mobileNavTopicBtn = document.getElementById('mobile-nav-topic');
        const mobileNavChatBtn = document.getElementById('mobile-nav-chat');
        const mobileNavCluesBtn = document.getElementById('mobile-nav-clues');
        const hostPanels = [document.getElementById('host-left-panel'), document.getElementById('host-middle-panel'), document.getElementById('host-right-panel')];
        const playerPanels = [document.getElementById('player-left-panel'), document.getElementById('player-middle-panel'), document.getElementById('player-right-panel')];
        const mobileNavBtns = [mobileNavTopicBtn, mobileNavChatBtn, mobileNavCluesBtn];

        // 新增：移动端面板切换函数
        function switchToMobilePanel(panelIndex) {
            const panels = (myRole === 'host') ? hostPanels : playerPanels;
            panels.forEach(p => p.classList.remove('mobile-visible'));
            panels[panelIndex].classList.add('mobile-visible');

            mobileNavBtns.forEach(b => b.classList.remove('active'));
            mobileNavBtns[panelIndex].classList.add('active');
        }

        // 修改：视图切换函数，增加移动端初始化逻辑
        function transitionToView(view, isFadeIn = true) {
            const allViews = [roomSelectionView, hostPromptView, hostView, playerView];
            allViews.forEach(v => v.classList.add('fade-out'));
            setTimeout(() => {
                allViews.forEach(v => v.style.display = 'none');
                const targetView = document.getElementById(view);
                if (targetView) {
                    targetView.style.display = (view.includes('-view')) ? 'grid' : 'flex';
                    if (isFadeIn) {
                        setTimeout(() => targetView.classList.remove('fade-out'), 10);
                    }
                    // 如果进入游戏视图，并且是移动端，则初始化移动端布局
                    if ((view === 'host-view' || view === 'player-view') && window.innerWidth <= 768) {
                        mobileNav.style.display = 'flex';
                        switchToMobilePanel(1); // 默认显示中间的聊天面板
                    }
                }
            }, 500);
        }

        // ... (所有其他函数保持不变: renderClues, generateReviewText, downloadReview, etc.)
        function renderClues(clues) { hostClueList.innerHTML = ''; playerClueList.innerHTML = ''; clues.forEach(clue => { const hostLi = document.createElement('li'); hostLi.className = `clue-item ${clue.highlighted ? 'highlighted' : ''}`; const starIcon = `<svg class="clue-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`; const trashIcon = `<svg class="clue-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`; hostLi.innerHTML = `<span class="clue-text">${clue.text}</span><div class="clue-actions"><button class="highlight-btn" title="着重" onclick="toggleHighlightClue('${clue.id}')">${starIcon}</button><button class="delete-btn" title="删除" onclick="deleteClue('${clue.id}')">${trashIcon}</button></div>`; hostClueList.appendChild(hostLi); const playerLi = document.createElement('li'); playerLi.className = `clue-item ${clue.highlighted ? 'highlighted' : ''}`; playerLi.innerHTML = `<span class="clue-text">${clue.text}</span>`; playerClueList.appendChild(playerLi); }); }
        function generateReviewText() { let content = "海龟汤游戏复盘\n====================\n\n【本局汤面】\n" + (questionInput.value || "无") + "\n\n【问答记录】\n"; const messages = document.querySelectorAll('#player-message-area .message'); if (messages.length > 0) { messages.forEach(msg => { const sender = msg.querySelector('.message-sender').textContent; const text = msg.childNodes[1].nodeValue.trim(); content += `${sender}: ${text}\n`; }); } else { content += "无\n"; } content += "\n【最终线索】\n"; const clues = document.querySelectorAll('#player-clue-list .clue-item'); if (clues.length > 0) { clues.forEach((clue, index) => { const isHighlighted = clue.classList.contains('highlighted'); const text = clue.querySelector('.clue-text').textContent; content += `${index + 1}. ${text} ${isHighlighted ? '(★重点)' : ''}\n`; }); } else { content += "无\n"; } content += "\n====================\n生成于海龟汤在线小屋"; return content; }
        function downloadReview() { const text = generateReviewText(); const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = '海龟汤复盘.txt'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function createMessageElement(data) { const { text, sender, role } = data; const className = role === 'host' ? 'host-msg' : 'player-msg'; const msgDiv = document.createElement('div'); msgDiv.classList.add('message', className); const senderSpan = document.createElement('div'); senderSpan.classList.add('message-sender'); senderSpan.textContent = sender; msgDiv.appendChild(senderSpan); msgDiv.appendChild(document.createTextNode(text)); return msgDiv; }
        function appendLocalMessage(data) { const hostMsgDiv = createMessageElement(data); if (myRole === 'host' && data.role === 'player') { hostMsgDiv.title = '点击加入线索列表'; hostMsgDiv.onclick = () => addClue(data.text); } hostMessageArea.appendChild(hostMsgDiv); hostMessageArea.scrollTop = hostMessageArea.scrollHeight; const playerMsgDiv = createMessageElement(data); playerMessageArea.appendChild(playerMsgDiv); playerMessageArea.scrollTop = playerMessageArea.scrollHeight; }
        function renderChatHistory(history) { hostMessageArea.innerHTML = ''; playerMessageArea.innerHTML = ''; history.forEach(msgData => appendLocalMessage(msgData)); }
        function switchTab(view, tabName) { const tabs = document.querySelectorAll(`#${view}-view .tab-btn`); const contents = document.querySelectorAll(`#${view}-view .tab-content`); tabs.forEach(tab => tab.classList.remove('active')); contents.forEach(content => content.classList.remove('active')); document.querySelector(`#${view}-view .tab-btn[onclick*="'${tabName}'"]`).classList.add('active'); document.getElementById(`${view}-${tabName}-content`).classList.add('active'); }
        
        joinRoomBtn.addEventListener('click', () => { const roomID = roomInput.value.trim(); if (roomID) { currentRoomID = roomID; socket.emit('joinRoom', roomID); } });
        roomInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') joinRoomBtn.click(); });
        becomeHostBtn.addEventListener('click', () => { socket.emit('becomeHost', currentRoomID); });
        
        socket.on('joinSuccess', ({ isHostAvailable, roomState }) => { questionInput.value = roomState.question; playerQuestionDisplay.textContent = roomState.question; renderClues(roomState.clues); renderChatHistory(roomState.chatHistory); if (isHostAvailable) { transitionToView('host-prompt'); } else { myRole = 'player'; transitionToView('player-view'); } });
        socket.on('roleConfirmed', (role) => { myRole = role; if (role === 'host') { transitionToView('host-view'); } });
        function sendMessage(senderRole) { const input = senderRole === 'host' ? hostMessageInput : playerMessageInput; const text = input.value.trim(); if (!text) return; const senderName = senderRole === 'host' ? '主持人' : '玩家'; socket.emit('sendMessage', { roomID: currentRoomID, messageData: { text, sender: senderName, role: senderRole } }); input.value = ''; }
        function quickReply(text) { socket.emit('sendMessage', { roomID: currentRoomID, messageData: { text, sender: '主持人', role: 'host' } }); }
        function addClue(text) { socket.emit('addClue', { roomID: currentRoomID, clueText: text }); }
        function deleteClue(clueId) { socket.emit('deleteClue', { roomID: currentRoomID, clueId }); }
        function toggleHighlightClue(clueId) { socket.emit('toggleHighlightClue', { roomID: currentRoomID, clueId }); }
        function announceResult(result) { socket.emit('announceResult', { roomID: currentRoomID, result }); }
        function resetGame() { socket.emit('resetGame', currentRoomID); }
        socket.on('questionUpdated', (question) => { questionInput.value = question; playerQuestionDisplay.textContent = question; });
        socket.on('newMessage', (data) => { appendLocalMessage(data); });
        socket.on('cluesUpdated', (clues) => { renderClues(clues); });
        socket.on('resultAnnounced', (result) => { const resultText = `--- 游戏结束...`; const systemMsg = document.createElement('div'); systemMsg.className = `system-message ${result === '成功' ? 'success' : 'fail'}`; systemMsg.textContent = resultText; hostMessageArea.appendChild(systemMsg.cloneNode(true)); playerMessageArea.appendChild(systemMsg.cloneNode(true)); hostMessageArea.scrollTop = hostMessageArea.scrollHeight; playerMessageArea.scrollTop = playerMessageArea.scrollHeight; btnSuccess.classList.add('hidden'); btnFail.classList.add('hidden'); btnReset.classList.remove('hidden'); hostDownloadBtn.disabled = false; playerDownloadBtn.disabled = false; });
        socket.on('gameReset', () => { alert("本局游戏已被主持人重置！"); window.location.reload(); });
        
        // 绑定所有事件
        questionInput.addEventListener('input', (e) => socket.emit('updateQuestion', { roomID: currentRoomID, questionText: e.target.value }));
        btnSuccess.addEventListener('click', () => announceResult('成功'));
        btnFail.addEventListener('click', () => announceResult('失败'));
        btnReset.addEventListener('click', resetGame);
        document.getElementById('host-send-btn').addEventListener('click', () => sendMessage('host'));
        document.getElementById('player-send-btn').addEventListener('click', () => sendMessage('player'));
        hostMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage('host'); });
        playerMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage('player'); });
        hostDownloadBtn.addEventListener('click', downloadReview);
        playerDownloadBtn.addEventListener('click', downloadReview);
        // 新增：绑定移动端导航按钮事件
        mobileNavTopicBtn.addEventListener('click', () => switchToMobilePanel(0));
        mobileNavChatBtn.addEventListener('click', () => switchToMobilePanel(1));
        mobileNavCluesBtn.addEventListener('click', () => switchToMobilePanel(2));
    </script>
</body>
</html>
