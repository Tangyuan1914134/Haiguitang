<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海龟汤在线小屋</title>
    <style>
        :root { --color-bg: #f4f3f1; --color-primary: #a7b2c3; --color-secondary: #d3c4be; --color-text: #5a5a5a; --color-text-light: #888; --color-border: #e0e0e0; --color-highlight: #f5e6d3; --color-success: #8dbba2; --color-fail: #e09a9a; --color-reset: #a7b2c3; --font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; --border-radius: 12px; --transition-speed: 0.3s; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-family); background-color: var(--color-bg); color: var(--color-text); overflow: hidden; }
        .centered-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--color-secondary), var(--color-primary)); transition: opacity 0.5s ease-out; }
        .centered-container h1 { color: white; font-size: 2.8em; font-weight: 300; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); text-align: center; padding: 0 20px;}
        .input-group { margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .room-input { padding: 15px 25px; font-size: 1.2em; border-radius: 50px; border: 2px solid white; background-color: rgba(255, 255, 255, 0.2); color: white; text-align: center; outline: none; transition: all var(--transition-speed) ease; }
        .room-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .room-input:focus { background-color: rgba(255, 255, 255, 0.4); border-color: white; }
        .join-btn { padding: 15px 35px; font-size: 1.2em; border-radius: 50px; border: none; cursor: pointer; background-color: white; color: var(--color-primary); font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all var(--transition-speed) ease; }
        .join-btn:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .role-btn { padding: 15px 35px; margin: 0 20px; font-size: 1.2em; border-radius: 50px; border: none; cursor: pointer; background-color: white; color: var(--color-primary); font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all var(--transition-speed) ease; }
        .role-btn:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .role-btn:disabled { cursor: not-allowed; opacity: 0.5; background-color: #eee; color: #aaa; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .game-container { display: none; grid-template-columns: 3fr 5fr 3fr; height: 100vh; gap: 15px; padding: 15px; box-sizing: border-box; }
        .panel { background-color: white; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px 25px; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { margin-top: 0; margin-bottom: 15px; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 10px; font-weight: 500; }
        .tab-nav { display: flex; }
        .tab-btn { flex: 1; padding: 12px; border: 1px solid var(--color-border); background-color: var(--color-bg); cursor: pointer; transition: all var(--transition-speed); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px; font-size: 0.95em; }
        .tab-btn.active { background-color: white; font-weight: 600; color: var(--color-primary); margin-bottom: -1px; }
        .tab-content-container { flex-grow: 1; border: 1px solid var(--color-border); border-radius: 0 0 8px 8px; position: relative; background-color: white; display: flex; }
        .tab-content { display: none; width: 100%; height: 100%; padding: 15px; box-sizing: border-box; }
        .tab-content.active { display: flex; }
        .editable-content { width: 100%; height: 100%; resize: none; border: none; padding: 0; font-size: 1em; font-family: var(--font-family); }
        .editable-content:focus { outline: none; box-shadow: none; }
        #question-input { font-size: 0.95em; }
        .game-result-buttons { margin-top: 15px; display: flex; gap: 10px; }
        .result-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-size: 1em; cursor: pointer; transition: opacity var(--transition-speed); }
        .result-btn:hover { opacity: 0.85; }
        #btn-success { background-color: var(--color-success); } #btn-fail { background-color: var(--color-fail); } #btn-reset { background-color: var(--color-reset); }
        .message-area { flex-grow: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column;}
        .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 12px; max-width: 80%; word-wrap: break-word; line-height: 1.5; }
        .message.player-msg { background-color: #eef1f5; align-self: flex-start; cursor: pointer; transition: background-color var(--transition-speed); }
        .message.player-msg:hover { background-color: #e3e8f0; }
        .message.host-msg { background-color: var(--color-secondary); color: white; align-self: flex-end; }
        .message.system-msg { align-self: center; background-color: transparent; text-align: center; font-size: 0.9em; color: var(--color-text-light); padding: 4px; }
        .message-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 4px; color: var(--color-primary); }
        .system-message { text-align: center; font-size: 0.9em; color: var(--color-text-light); padding: 10px; margin: 10px auto; width: 80%; border-radius: 8px; background-color: var(--color-bg); }
        .system-message.success { color: var(--color-success); font-weight: bold; } .system-message.fail { color: var(--color-fail); font-weight: bold; }
        .panel-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--color-border); }
        .quick-reply-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .quick-reply-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--color-secondary); background-color: transparent; color: var(--color-secondary); cursor: pointer; transition: all var(--transition-speed); }
        .quick-reply-btn:hover { background-color: var(--color-secondary); color: white; }
        .input-area { display: flex; gap: 10px; }
        .message-input { flex-grow: 1; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1em; font-family: var(--font-family); background-color: var(--color-bg); transition: all var(--transition-speed) ease; }
        .message-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(167, 178, 195, 0.2); background-color: white; }
        .send-btn { padding: 10px 20px; border: none; border-radius: 8px; background-color: var(--color-primary); color: white; cursor: pointer; transition: background-color var(--transition-speed); }
        .send-btn:hover { background-color: #8e9bb1; }
        .clue-list { flex-grow:1; overflow-y: auto; list-style-type: none; padding: 0; margin: 0; }
        .clue-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--color-border); transition: background-color var(--transition-speed); }
        .clue-item.highlighted { background-color: var(--color-highlight); font-weight: bold; }
        .clue-text { flex-grow: 1; line-height: 1.5; }
        .clue-actions button { background: none; border: none; cursor: pointer; margin-left: 8px; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 50%;}
        .clue-icon { width: 18px; height: 18px; fill: var(--color-text-light); transition: all var(--transition-speed); }
        .clue-actions button:hover .clue-icon { transform: scale(1.2); }
        .highlight-btn:hover .clue-icon { fill: var(--color-primary); }
        .delete-btn:hover .clue-icon { fill: var(--color-fail); }
        .download-btn { width: 100%; padding: 12px; margin-top: 15px; border: 1px solid var(--color-primary); background-color: transparent; color: var(--color-primary); border-radius: 8px; cursor: pointer; transition: all var(--transition-speed); }
        .download-btn:hover:not(:disabled) { background-color: var(--color-primary); color: white; }
        .download-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .hidden { display: none !important; }
        #mobile-nav { display: none; }
        @media (max-width: 768px) {
            body { overflow: auto; }
            .game-container { grid-template-columns: 1fr; height: auto; padding: 10px 10px 70px 10px; }
            .panel { display: none; min-height: calc(100vh - 80px); width: 100%; }
            .panel.mobile-visible { display: flex; }
            #mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
            .mobile-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; font-size: 12px; color: var(--color-text-light); padding: 8px 0; cursor: pointer; transition: color var(--transition-speed); }
            .mobile-nav-btn .nav-icon { width: 24px; height: 24px; fill: var(--color-text-light); margin-bottom: 2px; transition: fill var(--transition-speed); }
            .mobile-nav-btn.active, .mobile-nav-btn:hover { color: var(--color-primary); }
            .mobile-nav-btn.active .nav-icon, .mobile-nav-btn:hover .nav-icon { fill: var(--color-primary); }
        }
    </style>
</head>
<body>
    <div id="room-selection-view" class="centered-container"><h1>海龟汤在线小屋</h1><div class="input-group"><input type="text" id="room-input" class="room-input" placeholder="请输入房间号"><button id="join-room-btn" class="join-btn">加入/创建房间</button></div></div>
    <div id="role-selection-view" class="centered-container hidden"><h1>选择你的角色</h1><div class="input-group"><button id="host-btn" class="role-btn">我是主持人</button><button id="player-btn" class="role-btn">我是玩家</button></div></div>
    <div id="host-view" class="game-container"><div id="host-left-panel" class="panel"><div class="tab-nav"><button class="tab-btn active" onclick="switchTab('host', 'question')">海龟汤题目</button><button class="tab-btn" onclick="switchTab('host', 'manual')">主持人手册</button></div><div class="tab-content-container"><div id="host-question-content" class="tab-content active"><textarea id="question-input" class="editable-content" placeholder="在此输入“汤面”..."></textarea></div><div id="host-manual-content" class="tab-content"><textarea id="manual-input" class="editable-content" placeholder="在此输入“汤底”..."></textarea></div></div><div class="panel-footer"><div class="game-result-buttons"><button id="btn-success" class="result-btn">喝汤成功</button><button id="btn-fail" class="result-btn">喝汤失败</button><button id="btn-reset" class="result-btn hidden">重置游戏</button></div></div></div><div id="host-middle-panel" class="panel"><h3 class="panel-title">信息互动区</h3><div id="host-message-area" class="message-area"></div><div class="panel-footer"><div class="quick-reply-buttons"><button class="quick-reply-btn" onclick="quickReply('是')">是</button><button class="quick-reply-btn" onclick="quickReply('不是')">不是</button><button class="quick-reply-btn" onclick="quickReply('是也不是')">是也不是</button></div><div class="input-area"><input type="text" id="host-message-input" class="message-input" placeholder="输入自定义回复..."><button id="host-send-btn" class="send-btn">发送</button></div></div></div><div id="host-right-panel" class="panel"><h3 class="panel-title">线索列表</h3><ul id="host-clue-list" class="clue-list"></ul><div class="panel-footer"><button id="host-download-btn" class="download-btn" disabled>下载本局复盘</button></div></div></div>
    <div id="player-view" class="game-container"><div id="player-left-panel" class="panel"><h3 class="panel-title">海龟汤题目</h3><div id="player-question-display" style="font-size: 1.1em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; flex-grow: 1;">主持人尚未出题...</div></div><div id="player-middle-panel" class="panel"><h3 class="panel-title">提问区</h3><div id="player-message-area" class="message-area"></div><div class="panel-footer"><div class="input-area"><input type="text" id="player-message-input" class="message-input" placeholder="向主持人提问..."><button id="player-send-btn" class="send-btn">发送</button></div></div></div><div id="player-right-panel" class="panel"><h3 class="panel-title">线索列表</h3><ul id="player-clue-list" class="clue-list"></ul><div class="panel-footer"><button id="player-download-btn" class="download-btn" disabled>下载本局复盘</button></div></div></div>
    <div id="mobile-nav"><button id="mobile-nav-topic" class="mobile-nav-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg><span>汤面</span></button><button id="mobile-nav-chat" class="mobile-nav-btn active"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg><span>聊天</span></button><button id="mobile-nav-clues" class="mobile-nav-btn"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zm0-5h18v-2H3v2zm0-5h18V6H3v2zm15 10l-4-4 4-4v8z"/></svg><span>线索</span></button></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io("https://hgtang.onrender.com", { transports: ["websocket"] });
        let myRole = null;
        let myName = null;
        let currentRoomID = null;

        // --- DOM 元素获取 (保持不变) ---
        const roomSelectionView = document.getElementById('room-selection-view'); const roleSelectionView = document.getElementById('role-selection-view'); const roomInput = document.getElementById('room-input'); const joinRoomBtn = document.getElementById('join-room-btn'); const hostBtn = document.getElementById('host-btn'); const playerBtn = document.getElementById('player-btn');
        const hostView = document.getElementById('host-view'); const playerView = document.getElementById('player-view'); const questionInput = document.getElementById('question-input'); const manualInput = document.getElementById('manual-input'); const hostMessageArea = document.getElementById('host-message-area'); const hostMessageInput = document.getElementById('host-message-input'); const hostClueList = document.getElementById('host-clue-list'); const btnSuccess = document.getElementById('btn-success'); const btnFail = document.getElementById('btn-fail'); const btnReset = document.getElementById('btn-reset'); const playerQuestionDisplay = document.getElementById('player-question-display'); const playerMessageArea = document.getElementById('player-message-area'); const playerMessageInput = document.getElementById('player-message-input'); const playerClueList = document.getElementById('player-clue-list');
        const hostDownloadBtn = document.getElementById('host-download-btn'); const playerDownloadBtn = document.getElementById('player-download-btn');
        const mobileNav = document.getElementById('mobile-nav'); const mobileNavTopicBtn = document.getElementById('mobile-nav-topic'); const mobileNavChatBtn = document.getElementById('mobile-nav-chat'); const mobileNavCluesBtn = document.getElementById('mobile-nav-clues'); const hostPanels = [document.getElementById('host-left-panel'), document.getElementById('host-middle-panel'), document.getElementById('host-right-panel')]; const playerPanels = [document.getElementById('player-left-panel'), document.getElementById('player-middle-panel'), document.getElementById('player-right-panel')]; const mobileNavBtns = [mobileNavTopicBtn, mobileNavChatBtn, mobileNavCluesBtn];

        // --- 视图切换核心函数 (已彻底修复) ---
        function transitionToView(viewId) {
            const allViews = [roomSelectionView, roleSelectionView, hostView, playerView];
            const targetView = document.getElementById(viewId);

            if (!targetView) {
                console.error("Target view not found:", viewId);
                return;
            }

            // 1. 隐藏所有视图
            allViews.forEach(view => {
                view.style.display = 'none';
            });

            // 2. 移除目标视图的 'hidden' 类 (这是关键修复！)
            targetView.classList.remove('hidden');

            const isGameView = viewId === 'host-view' || viewId === 'player-view';

            // 3. 为目标视图设置正确的 display 属性
            targetView.style.display = isGameView ? 'grid' : 'flex';

            // 4. 处理移动端导航和面板的显示
            if (isGameView) {
                if (window.innerWidth <= 768) {
                    mobileNav.style.display = 'flex';
                    // 默认显示聊天面板
                    switchToMobilePanel(1); 
                } else {
                    mobileNav.style.display = 'none';
                    // 桌面端，确保所有面板都可见
                    const panelsToShow = myRole === 'host' ? hostPanels : playerPanels;
                    panelsToShow.forEach(p => p.style.display = 'flex');
                }
            } else {
                mobileNav.style.display = 'none';
            }
        }
        
        // --- 辅助功能函数 (保持不变) ---
        function renderClues(clues) { hostClueList.innerHTML = ''; playerClueList.innerHTML = ''; clues.forEach(clue => { const hostLi = document.createElement('li'); hostLi.className = `clue-item ${clue.highlighted ? 'highlighted' : ''}`; const starIcon = `<svg class="clue-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`; const trashIcon = `<svg class="clue-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`; hostLi.innerHTML = `<span class="clue-text">${clue.text}</span><div class="clue-actions"><button class="highlight-btn" title="着重" onclick="toggleHighlightClue('${clue.id}')">${starIcon}</button><button class="delete-btn" title="删除" onclick="deleteClue('${clue.id}')">${trashIcon}</button></div>`; hostClueList.appendChild(hostLi); const playerLi = document.createElement('li'); playerLi.className = `clue-item ${clue.highlighted ? 'highlighted' : ''}`; playerLi.innerHTML = `<span class="clue-text">${clue.text}</span>`; playerClueList.appendChild(playerLi); }); }
        function generateReviewText() { let content = "海龟汤游戏复盘\n====================\n\n【本局汤面】\n" + (questionInput.value || "无") + "\n\n【问答记录】\n"; const messages = document.querySelectorAll('#player-message-area .message'); if (messages.length > 0) { messages.forEach(msg => { const sender = msg.querySelector('.message-sender').textContent; const text = msg.childNodes[1].nodeValue.trim(); content += `${sender}: ${text}\n`; }); } else { content += "无\n"; } content += "\n【最终线索】\n"; const clues = document.querySelectorAll('#player-clue-list .clue-item'); if (clues.length > 0) { clues.forEach((clue, index) => { const isHighlighted = clue.classList.contains('highlighted'); const text = clue.querySelector('.clue-text').textContent; content += `${index + 1}. ${text} ${isHighlighted ? '(★重点)' : ''}\n`; }); } else { content += "无\n"; } content += "\n====================\n生成于海龟汤在线小屋"; return content; }
        function downloadReview() { const text = generateReviewText(); const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = '海龟汤复盘.txt'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function createMessageElement(data) { const { text, sender, role } = data; const className = role === 'system' ? 'system-msg' : (role === 'host' ? 'host-msg' : 'player-msg'); const msgDiv = document.createElement('div'); msgDiv.classList.add('message', className); if(role !== 'system') { const senderSpan = document.createElement('div'); senderSpan.classList.add('message-sender'); senderSpan.textContent = sender; msgDiv.appendChild(senderSpan); } msgDiv.appendChild(document.createTextNode(text)); return msgDiv; }
        function appendLocalMessage(data) { const hostMsgDiv = createMessageElement(data); if (myRole === 'host' && data.role === 'player') { hostMsgDiv.title = '点击加入线索列表'; hostMsgDiv.onclick = () => addClue(data.text); } hostMessageArea.appendChild(hostMsgDiv); hostMessageArea.scrollTop = hostMessageArea.scrollHeight; const playerMsgDiv = createMessageElement(data); playerMessageArea.appendChild(playerMsgDiv); playerMessageArea.scrollTop = playerMessageArea.scrollHeight; }
        function renderChatHistory(history) { hostMessageArea.innerHTML = ''; playerMessageArea.innerHTML = ''; history.forEach(msgData => appendLocalMessage(msgData)); }
        function switchToMobilePanel(panelIndex) { const panels = (myRole === 'host') ? hostPanels : playerPanels; panels.forEach(p => p.style.display = 'none'); panels[panelIndex].style.display = 'flex'; panels[panelIndex].classList.add('mobile-visible'); mobileNavBtns.forEach(b => b.classList.remove('active')); mobileNavBtns[panelIndex].classList.add('active'); }
        function switchTab(view, tabName) { const tabs = document.querySelectorAll(`#${view}-view .tab-btn`); const contents = document.querySelectorAll(`#${view}-view .tab-content`); tabs.forEach(tab => tab.classList.remove('active')); contents.forEach(content => content.classList.remove('active')); document.querySelector(`#${view}-view .tab-btn[onclick*="'${tabName}'"]`).classList.add('active'); document.getElementById(`${view}-${tabName}-content`).classList.add('active'); }

        // --- 事件监听器 (保持不变) ---
        joinRoomBtn.addEventListener('click', () => { const roomID = roomInput.value.trim(); if (roomID) { currentRoomID = roomID; socket.emit('joinRoom', roomID); } });
        roomInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') joinRoomBtn.click(); });
        hostBtn.addEventListener('click', () => { hostBtn.disabled = true; hostBtn.textContent = '请求中...'; socket.emit('selectRole', { roomID: currentRoomID, role: 'host' }); });
        playerBtn.addEventListener('click', () => { playerBtn.disabled = true; playerBtn.textContent = '请求中...'; socket.emit('selectRole', { roomID: currentRoomID, role: 'player' }); });
        
        // --- Socket.IO 事件处理 (使用已修复的 transitionToView 函数) ---
        socket.on('joinSuccess', ({ hasHost }) => { transitionToView('role-selection-view'); hostBtn.disabled = hasHost; hostBtn.textContent = '我是主持人'; playerBtn.disabled = false; playerBtn.textContent = '我是玩家'; });
        socket.on('hostUpdate', (hasHost) => { hostBtn.disabled = hasHost; });
        socket.on('roleConfirmed', (role) => { myRole = role; transitionToView(role === 'host' ? 'host-view' : 'player-view'); });
        socket.on('roleRejected', (role) => { if (role === 'host') { alert("该房间已经有主持人了！"); hostBtn.disabled = true; hostBtn.textContent = '我是主持人'; } });
        socket.on('gameStateSync', (roomState) => { myName = roomState.myName; questionInput.value = roomState.question; playerQuestionDisplay.textContent = roomState.question; renderClues(roomState.clues); renderChatHistory(roomState.chatHistory); });
        
        function sendMessage(senderRole) { const input = senderRole === 'host' ? hostMessageInput : playerMessageInput; const text = input.value.trim(); if (!text) return; socket.emit('sendMessage', { roomID: currentRoomID, messageData: { text, sender: myName, role: senderRole } }); input.value = ''; }
        function quickReply(text) { socket.emit('sendMessage', { roomID: currentRoomID, messageData: { text, sender: '主持人', role: 'host' } }); }
        function addClue(text) { socket.emit('addClue', { roomID: currentRoomID, clueText: text }); }
        function deleteClue(clueId) { socket.emit('deleteClue', { roomID: currentRoomID, clueId }); }
        function toggleHighlightClue(clueId) { socket.emit('toggleHighlightClue', { roomID: currentRoomID, clueId }); }
        function announceResult(result) { socket.emit('announceResult', { roomID: currentRoomID, result }); }
        function resetGame() { socket.emit('resetGame', currentRoomID); }
        
        socket.on('questionUpdated', (question) => { questionInput.value = question; playerQuestionDisplay.textContent = question; });
        socket.on('newMessage', (data) => { appendLocalMessage(data); });
        socket.on('cluesUpdated', (clues) => { renderClues(clues); });
        socket.on('resultAnnounced', (result) => { const resultText = `--- 游戏结束，主持人宣布：喝汤${result}！ ---`; const systemMsg = document.createElement('div'); systemMsg.className = `system-message ${result === '成功' ? 'success' : 'fail'}`; systemMsg.textContent = resultText; hostMessageArea.appendChild(systemMsg.cloneNode(true)); playerMessageArea.appendChild(systemMsg.cloneNode(true)); hostMessageArea.scrollTop = hostMessageArea.scrollHeight; playerMessageArea.scrollTop = playerMessageArea.scrollHeight; btnSuccess.classList.add('hidden'); btnFail.classList.add('hidden'); btnReset.classList.remove('hidden'); hostDownloadBtn.disabled = false; playerDownloadBtn.disabled = false; });
        socket.on('gameReset', () => { alert("本局游戏已被主持人重置或主持人已离开！"); window.location.reload(); });
        
        questionInput.addEventListener('input', (e) => socket.emit('updateQuestion', { roomID: currentRoomID, questionText: e.target.value }));
        btnSuccess.addEventListener('click', () => announceResult('成功'));
        btnFail.addEventListener('click', () => announceResult('失败'));
        btnReset.addEventListener('click', resetGame);
        document.getElementById('host-send-btn').addEventListener('click', () => sendMessage('host'));
        document.getElementById('player-send-btn').addEventListener('click', () => sendMessage('player'));
        hostMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage('host'); });
        playerMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage('player'); });
        hostDownloadBtn.addEventListener('click', downloadReview);
        playerDownloadBtn.addEventListener('click', downloadReview);
        mobileNavTopicBtn.addEventListener('click', () => switchToMobilePanel(0));
        mobileNavChatBtn.addEventListener('click', () => switchToMobilePanel(1));
        mobileNavCluesBtn.addEventListener('click', () => switchToMobilePanel(2));
    </script>
</body>
</html>
